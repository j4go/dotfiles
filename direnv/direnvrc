layout_python_flex() {
  local env_name=$1
  local requested_version="${2:-3.13.12}"
  local max_supported="3.14.3"

  export MAMBA_ROOT_PREFIX="$HOME/.micromamba"
  mkdir -p "$MAMBA_ROOT_PREFIX"

  # --- ä¼˜åŒ–ï¼šä½¿ç”¨ Python3 è¿›è¡Œå¯é çš„ç‰ˆæœ¬æ¯”è¾ƒ (macOS æ­¤æ—¶å¿…æœ‰ python3) ---
  # è¿™æ¯” sort -V æ›´å¯é ï¼Œä¸éœ€è¦å®‰è£… coreutils
  local final_version=$(/usr/bin/python3 -c "
v1='$requested_version'.split('.')
v2='$max_supported'.split('.')
# å°†ç‰ˆæœ¬å·è¡¥é½ä¸º3ä½ (ä¾‹å¦‚ 3.12 -> 3.12.0) ä»¥ä¾¿æ¯”è¾ƒ
def pad(v): return [int(x) for x in v] + [0]*(3-len(v))
print('$requested_version' if pad(v1) < pad(v2) else '$max_supported')
")

  if [ "$requested_version" != "$final_version" ]; then
    echo "âš ï¸  Requested $requested_version exceeds max supported $max_supported."
    final_version=$max_supported
  fi

  # --- åˆå§‹åŒ– Micromamba ---
  eval "$(micromamba shell hook -s bash --root-prefix "$MAMBA_ROOT_PREFIX")"

  # --- æ™ºèƒ½åˆ›å»ºçŽ¯å¢ƒ ---
  # æ£€æŸ¥çŽ¯å¢ƒæ˜¯å¦å­˜åœ¨ï¼Œä¸” Python ç‰ˆæœ¬æ˜¯å¦åŒ¹é… (ç®€å•æ£€æŸ¥)
  if [ ! -d "$MAMBA_ROOT_PREFIX/envs/$env_name" ]; then
    echo "ðŸ“¦ Creating environment '$env_name' with Python $final_version..."
    micromamba create -n "$env_name" python=$final_version -c conda-forge -y
  fi

  micromamba activate "$env_name"

  # --- UV åŒæ­¥ ---
  export UV_PYTHON="$(which python)"
  
  if [ -f "pyproject.toml" ]; then
    # å¢žåŠ  || true é˜²æ­¢ uv sync å¤±è´¥å¯¼è‡´ direnv å´©æºƒï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
    uv sync --quiet || echo "âŒ 'uv sync' failed. Check your pyproject.toml python version requirements."
  fi
  
  echo "âœ… Environment ready: $(python --version)"
}
