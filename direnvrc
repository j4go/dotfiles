# ~/.config/direnv/direnvrc
# æ³¨æ„ï¼šæ­¤æ–‡ä»¶å¿…é¡»ä½¿ç”¨ Bash è¯­æ³•ï¼Œå³ä½¿ä½ åœ¨ä½¿ç”¨ Zshã€‚

layout_python_flex() {
  local env_name=$1
  local requested_version="${2:-3.13.12}"
  local max_supported="3.14.3"

  # å®šä¹‰ Micromamba æ ¹ç›®å½•
  export MAMBA_ROOT_PREFIX="$HOME/.micromamba"
  mkdir -p "$MAMBA_ROOT_PREFIX"

  # --- ç‰ˆæœ¬æ’åºé€»è¾‘ (é€‚é… macOS) ---
  # macOS é»˜è®¤ sort ä¸æ”¯æŒ -Vï¼Œå°è¯•æ£€æµ‹ GNU sort (gsort)
  local sort_cmd="sort"
  if command -v gsort &> /dev/null; then
      sort_cmd="gsort"
  fi

  # æ¯”è¾ƒç‰ˆæœ¬å·
  local final_version=$(printf "%s\n%s" "$requested_version" "$max_supported" | $sort_cmd -V | head -n1)

  if [ "$requested_version" != "$final_version" ]; then
    echo "âš ï¸  Requested $requested_version exceeds max supported $max_supported."
    final_version=$max_supported
  fi
  
  echo "ğŸš€ Python Version: $final_version"

  # --- å…³é”®ï¼šMicromamba åˆå§‹åŒ– ---
  # å¿…é¡»ä½¿ç”¨ -s bashï¼Œå› ä¸º direnv åœ¨ bash å­ shell ä¸­è¿è¡Œ
  eval "$(micromamba shell hook -s bash --root-prefix "$MAMBA_ROOT_PREFIX")"

  # æ£€æŸ¥å¹¶åˆ›å»ºç¯å¢ƒ
  if [ ! -d "$MAMBA_ROOT_PREFIX/envs/$env_name" ]; then
    echo "ğŸ“¦ Creating environment in $MAMBA_ROOT_PREFIX/envs/$env_name"
    micromamba create -n "$env_name" python=$final_version -c conda-forge -y
  fi

  # æ¿€æ´»ç¯å¢ƒ (direnv ä¼šæ•è·æ­¤æ“ä½œäº§ç”Ÿçš„ç¯å¢ƒå˜é‡å˜åŒ–)
  micromamba activate "$env_name"

  # --- UV é›†æˆ ---
  # è®¾ç½® UV ä½¿ç”¨å½“å‰çš„ python è·¯å¾„
  export UV_PYTHON="$(which python)"
  
  if [ -f "pyproject.toml" ]; then
    # echo "ğŸ”¥ Syncing dependencies with uv..."
    uv sync --quiet
  fi
}
